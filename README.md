## BackGround
#### Bw+tree
Bw-tree는 B-tree와 Write-Ahead의 약자로, 고성능 동시성과 낮은 지연 시간이 요구되는 데이터베이스 및 파일 시스템용으로 설계된 데이터 구조이다. B-tree의 변형으로, 비휘발성 메모리를 사용하는 시스템이나 효율적인 락-프리(lock-free) 작업이 필요한 시나리오에 최적화되어 있다.

Bw-tree는 여러 주요 특성을 통해 높은 성능과 동시성을 달성한다:

래치-프리(Latch-free) 설계: 전통적인 잠금 대신, 원자적 연산을 사용하여 동시성을 관리하여, 멀티 스레드 환경에서의 오버헤드와 잠재적인 병목 현상을 줄인다.

델타 노드 (delta-node): 변경 사항을 기록하는 데 사용되며, 이는 기본 구조의 변경 없이도 업데이트를 효율적으로 수행할 수 있게 한다.

이러한 특성 덕분에 Bw-tree는 인 메모리 데이터베이스와 같이 높은 동시성과 낮은 지연 시간을 필요로 하는 작업에 적합하다.

## Problem Definition
#### Problem situation
수천 명의 사용자가 특정 좌석에 액세스하는 콘서트 티켓팅과 같이 특정 핵심 정보를 집중적으로 수정해야 하는 서비스에서는 만족스러운 사용자 경험을 위해 응답 시간이 매우 중요하다. 하지만, 기존의 Bw+tree의 경우, 좁은 영역의 키에 많은 량의 요청이 발생하였을 때, 성능이 하락하는 문제가 존재한다. 이 문제는 [표-1]에서 명백히 나타나며, 연속된 64개 key 범위에서 혼잡이 발생할 경우 응답 시간이 크게 지연되는 것을 볼 수 있다.
![image](https://user-images.githubusercontent.com/96645965/216049878-15744ca6-9f01-40a6-a94e-8281c5cc9879.png)
[Table-1]
#### [Table-1] analysis
이 표는 bw-tree가 좁은 키 범위에서 대량의 수정을 처리할 수 있는 능력을 검토한 실험 결과이다. 1,024x1,024 요소를 가진 bw-tree를 생성하고, 20개의 스레드가 1,024x1,024번 주어진 작업을 시도한다. 작업은 범위 내의 임의의 키에 대하여, 해당 키를 가진 요소를 삭제한 다음 삽입한다. 이러한 작업의 총 소요 시간과 성공 비율을 측정하였다. (Bw+ Tree의 경우, 삽입 작업과 삭제 작업과 같은 기본 작업이 원자적 연산으로 되어있다. 따라서, 실패한 연산수를 통하여 성공 비율을 측정하였다.)

#### Key Observations
1,024x1,024 요소를 가진 bw-tree에서 각 리프 노드는 64개의 요소를 포함한다. 각 작업은 트리 구조를 탐색하고 델타의 수가 8을 초과하는 경우 리프 노드에 델타 정보를 추가하는 것이 포함되어있다. 사용 가능한 키의 수가 2에서 64까지의 범위일 때, 시간 소비와 성공 비율 사이에 양의 상관관계가 관찰된다. 이를 통해, 노드의 혼잡도가 증가함에 따라 수정 작업에 대한 오버헤드도 선형적으로 증가한다는 것을 알 수 있다. 그러나 사용 가능한 키의 수가 64에서 1,024x1,024까지의 범위일 때, 성공 비율은 비슷하게 유지되며 혼잡도가 감소함에 따라 성능이 향상된다.

## New Version Design
#### Concept
새로운 디자인은 교통 혼잡을 완화하기 위해 새로운 도로를 추가하는 것과 비슷하다. 혼잡한 리프 노드를 분할함으로써 동일한 키 범위에 대한 새로운 경로를 생성하여 전체 응답 시간을 향상시킬 수 있다. 사용자가 향후 작업 부하의 정체 수준을 예측하고 더 나은 성능을 위해 분할 옵션을 활성화할 수 있다고 가정한다.

#### Usage
불리언 멤버인 congestion_control가 트리 클래스에 추가되었다. 사용자는 tree->congestion_control을 true로 설정하여 새 정책을 활성화할 수 있다.

#### Design Rational and Corretness
새로운 분할 정책에는 혼잡 수준을 식별하기 위한 기준이 필요하다. 기존 mapping_table과 함께 새 테이블(success_count, op_count, op_base 및 node_flag)을 도입하였다. 이 테이블은 각 리프 노드에 대한 작업 시도 및 성공 횟수를 계산하여 정체 수준을 평가하기 위한 데이터를 제공한다. 분할 여부는 성공률 임계값 90%를 기준으로 결정된다. 또한 특정 노드의 병합을 방지하기 위해 node_flag를 표시를 사용한다.

### custom test cases
'bwtree_test_density':
- BwtreeTest_db_init: 1M 키로 bw-tree 구조를 생성하는 데 걸리는 시간을 측정한다.
- BwtreeTest_density_with_exist_db: 지정된 키 범위 내에 대하여 기존 로직의 시간 성능을 측정한다.
- BwtreeTest_density_with_exist_db_with_split_logic: 지정된 키 범위 내에 대하여 새로운 로직의 시간 성능을 측정한다.

## Performance analysis
[Table2]는 이전 버전과 새 버전 간의 성능 차이를 보여준다. 특히 이전에 가장 낮은 성능을 보였던 연속된 16개 키에 대한 워크로드에서, 새 버전은 약 33%의 성능 향상을 달성하였다.
![image](https://user-images.githubusercontent.com/96645965/216049921-7d82db04-03f3-40b3-8ca7-34f1c4d63e6c.png)
[Table2]   
